<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facturaci√≥n Electr√≥nica - MiPyME</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        header h1 {
            font-size: 2em;
        }
        
        .btn-back {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            text-decoration: none;
            transition: all 0.3s;
        }
        
        .btn-back:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        .content {
            padding: 40px;
        }
        
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }
        
        .stat-box h3 {
            font-size: 2em;
            margin-bottom: 5px;
        }
        
        .stat-box p {
            opacity: 0.9;
        }
        
        .btn-new-invoice {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .btn-new-invoice:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(67, 233, 123, 0.3);
        }
        
        .invoices-table {
            width: 100%;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .invoices-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .invoices-table thead {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        .invoices-table th {
            padding: 15px;
            text-align: left;
            font-weight: bold;
        }
        
        .invoices-table td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .invoices-table tbody tr:hover {
            background: #f8f9ff;
            cursor: pointer;
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 50px;
            font-size: 0.85em;
            font-weight: bold;
        }
        
        .status-generated {
            background: #e6f2ff;
            color: #0066cc;
        }
        
        .status-signed {
            background: #e6ffe6;
            color: #00cc66;
        }
        
        .status-sent {
            background: #fff3e6;
            color: #ff9900;
        }
        
        .invoice-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-icon {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }
        
        .btn-view {
            background: #4facfe;
            color: white;
        }
        
        .btn-pdf {
            background: #f5576c;
            color: white;
        }
        
        .btn-xml {
            background: #43e97b;
            color: white;
        }
        
        .btn-icon:hover {
            transform: scale(1.1);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .modal-header h2 {
            color: #2d3748;
        }
        
        .btn-close {
            background: none;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: #718096;
        }
        
        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
        }
        
        .form-section h3 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.3em;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2d3748;
            font-weight: bold;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4facfe;
        }
        
        .items-section {
            margin: 30px 0;
        }
        
        .item-row {
            display: grid;
            grid-template-columns: 3fr 1fr 1fr 1fr auto;
            gap: 15px;
            align-items: end;
            margin-bottom: 15px;
        }
        
        .btn-add-item {
            background: #43e97b;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .btn-remove-item {
            background: #f5576c;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }
        
        .totals-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-top: 30px;
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .total-row.grand-total {
            border-bottom: none;
            font-size: 1.3em;
            font-weight: bold;
            color: #2d3748;
            margin-top: 10px;
            padding-top: 20px;
            border-top: 3px solid #4facfe;
        }
        
        .btn-submit {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 30px;
        }
        
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.3);
        }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4facfe;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 40px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }
        
        .empty-state-icon {
            font-size: 5em;
            margin-bottom: 20px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üßæ Facturaci√≥n Electr√≥nica</h1>
            <a href="/" class="btn-back">‚Üê Volver al Panel</a>
        </header>
        
        <div class="content">
            <div class="toolbar">
                <h2 style="color: #2d3748;">Facturas Generadas</h2>
                <button class="btn-new-invoice" onclick="openInvoiceModal()">
                    ‚ûï Nueva Factura
                </button>
            </div>
            
            <div class="stats-summary" id="statsContainer">
                <div class="loader"></div>
            </div>
            
            <div id="invoicesContainer">
                <div class="loader"></div>
            </div>
        </div>
    </div>
    
    <!-- Modal Nueva Factura -->
    <div id="invoiceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üßæ Nueva Factura Electr√≥nica</h2>
                <button class="btn-close" onclick="closeInvoiceModal()">√ó</button>
            </div>
            
            <form id="invoiceForm">
                <!-- Informaci√≥n del Vendedor -->
                <div class="form-section">
                    <h3>üè¢ Informaci√≥n del Vendedor</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nombre/Raz√≥n Social:</label>
                            <input type="text" name="seller_name" required>
                        </div>
                        <div class="form-group">
                            <label>NIT/Tax Code:</label>
                            <input type="text" name="seller_tax_code" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Direcci√≥n:</label>
                            <input type="text" name="seller_address" required>
                        </div>
                        <div class="form-group">
                            <label>Tel√©fono:</label>
                            <input type="tel" name="seller_phone" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" name="seller_email" required>
                    </div>
                </div>
                
                <!-- Informaci√≥n del Comprador -->
                <div class="form-section">
                    <h3>üë§ Informaci√≥n del Cliente</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nombre/Raz√≥n Social:</label>
                            <input type="text" name="buyer_name" required>
                        </div>
                        <div class="form-group">
                            <label>NIT/Tax Code:</label>
                            <input type="text" name="buyer_tax_code">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Direcci√≥n:</label>
                            <input type="text" name="buyer_address" required>
                        </div>
                        <div class="form-group">
                            <label>Tel√©fono:</label>
                            <input type="tel" name="buyer_phone">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" name="buyer_email">
                    </div>
                </div>
                
                <!-- Items de Factura -->
                <div class="form-section">
                    <h3>üì¶ Productos/Servicios</h3>
                    <div id="itemsContainer">
                        <div class="item-row">
                            <div class="form-group">
                                <label>Descripci√≥n:</label>
                                <input type="text" class="item-description" required>
                            </div>
                            <div class="form-group">
                                <label>Cantidad:</label>
                                <input type="number" class="item-quantity" step="0.01" value="1" required onchange="calculateTotals()">
                            </div>
                            <div class="form-group">
                                <label>Precio Unit.:</label>
                                <input type="number" class="item-price" step="0.01" required onchange="calculateTotals()">
                            </div>
                            <div class="form-group">
                                <label>Monto:</label>
                                <input type="number" class="item-amount" readonly>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn-add-item" onclick="addItem()">‚ûï Agregar Item</button>
                </div>
                
                <!-- Informaci√≥n Adicional -->
                <div class="form-section">
                    <h3>üí≥ Informaci√≥n de Pago</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>M√©todo de Pago:</label>
                            <select name="payment_method" required>
                                <option value="">Seleccionar...</option>
                                <option value="Bank Transfer">Transferencia Bancaria</option>
                                <option value="Cash">Efectivo</option>
                                <option value="Credit Card">Tarjeta de Cr√©dito</option>
                                <option value="Debit Card">Tarjeta de D√©bito</option>
                                <option value="Check">Cheque</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Moneda:</label>
                            <select name="currency" required>
                                <option value="VND" selected>VND (ƒê·ªìng Vietnamita)</option>
                                <option value="USD">USD (D√≥lar)</option>
                                <option value="EUR">EUR (Euro)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notas:</label>
                        <textarea name="notes" rows="3" placeholder="Notas adicionales..."></textarea>
                    </div>
                </div>
                
                <!-- Totales -->
                <div class="totals-section">
                    <div class="total-row">
                        <span>Subtotal:</span>
                        <span id="subtotal">0.00 VND</span>
                    </div>
                    <div class="total-row">
                        <span>IVA (10%):</span>
                        <span id="vat">0.00 VND</span>
                    </div>
                    <div class="total-row grand-total">
                        <span>TOTAL:</span>
                        <span id="total">0.00 VND</span>
                    </div>
                </div>
                
                <button type="submit" class="btn-submit">‚úì Generar Factura Electr√≥nica</button>
            </form>
        </div>
    </div>
    
    <script>
        let allInvoices = [];
        
        // Cargar facturas al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            loadInvoices();
            setupFormSubmit();
        });
        
        // Cargar facturas desde el servidor
        async function loadInvoices() {
            try {
                const response = await fetch('/invoices/list');
                const data = await response.json();
                allInvoices = data.invoices || [];
                displayStats();
                displayInvoices(allInvoices);
            } catch (error) {
                console.error('Error al cargar facturas:', error);
                document.getElementById('invoicesContainer').innerHTML = 
                    '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><h3>Error al cargar facturas</h3></div>';
            }
        }
        
        // Mostrar estad√≠sticas
        function displayStats() {
            const total = allInvoices.length;
            const signed = allInvoices.filter(inv => inv.is_signed).length;
            const totalAmount = allInvoices.reduce((sum, inv) => sum + (inv.total || 0), 0);
            
            document.getElementById('statsContainer').innerHTML = `
                <div class="stat-box">
                    <h3>${total}</h3>
                    <p>Total Facturas</p>
                </div>
                <div class="stat-box" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <h3>${signed}</h3>
                    <p>Firmadas</p>
                </div>
                <div class="stat-box" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <h3>${formatCurrency(totalAmount)}</h3>
                    <p>Monto Total</p>
                </div>
            `;
        }
        
        // Mostrar facturas
        function displayInvoices(invoices) {
            const container = document.getElementById('invoicesContainer');
            
            if (invoices.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üßæ</div>
                        <h3>No hay facturas</h3>
                        <p>Genera tu primera factura electr√≥nica</p>
                    </div>
                `;
                return;
            }
            
            const html = `
                <div class="invoices-table">
                    <table>
                        <thead>
                            <tr>
                                <th>N√∫mero</th>
                                <th>Fecha</th>
                                <th>Cliente</th>
                                <th>Total</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${invoices.map(inv => `
                                <tr>
                                    <td><strong>${inv.invoice_number}</strong></td>
                                    <td>${formatDate(inv.invoice_date)}</td>
                                    <td>${inv.buyer_info.name}</td>
                                    <td><strong>${formatCurrency(inv.total)} ${inv.currency}</strong></td>
                                    <td>
                                        <span class="status-badge ${inv.is_signed ? 'status-signed' : 'status-generated'}">
                                            ${inv.is_signed ? '‚úì Firmada' : 'üìù Generada'}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="invoice-actions">
                                            <button class="btn-icon btn-view" onclick="viewInvoice('${inv.id}')" title="Ver">üëÅÔ∏è</button>
                                            <button class="btn-icon btn-pdf" onclick="downloadPDF('${inv.id}')" title="PDF">üìÑ</button>
                                            <button class="btn-icon btn-xml" onclick="downloadXML('${inv.id}')" title="XML">üìã</button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // Agregar nuevo item
        function addItem() {
            const container = document.getElementById('itemsContainer');
            const newItem = document.createElement('div');
            newItem.className = 'item-row';
            newItem.innerHTML = `
                <div class="form-group">
                    <input type="text" class="item-description" required>
                </div>
                <div class="form-group">
                    <input type="number" class="item-quantity" step="0.01" value="1" required onchange="calculateTotals()">
                </div>
                <div class="form-group">
                    <input type="number" class="item-price" step="0.01" required onchange="calculateTotals()">
                </div>
                <div class="form-group">
                    <input type="number" class="item-amount" readonly>
                </div>
                <button type="button" class="btn-remove-item" onclick="this.parentElement.remove(); calculateTotals();">üóëÔ∏è</button>
            `;
            container.appendChild(newItem);
        }
        
        // Calcular totales
        function calculateTotals() {
            let subtotal = 0;
            
            document.querySelectorAll('.item-row').forEach(row => {
                const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                const amount = quantity * price;
                row.querySelector('.item-amount').value = amount.toFixed(2);
                subtotal += amount;
            });
            
            const vatRate = 0.10;
            const vat = subtotal * vatRate;
            const total = subtotal + vat;
            
            const currency = document.querySelector('[name="currency"]').value || 'VND';
            
            document.getElementById('subtotal').textContent = `${formatCurrency(subtotal)} ${currency}`;
            document.getElementById('vat').textContent = `${formatCurrency(vat)} ${currency}`;
            document.getElementById('total').textContent = `${formatCurrency(total)} ${currency}`;
        }
        
        // Configurar env√≠o de formulario
        function setupFormSubmit() {
            document.getElementById('invoiceForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Recopilar datos del formulario
                const formData = new FormData(this);
                const items = [];
                
                document.querySelectorAll('.item-row').forEach(row => {
                    const description = row.querySelector('.item-description').value;
                    const quantity = parseFloat(row.querySelector('.item-quantity').value);
                    const unit_price = parseFloat(row.querySelector('.item-price').value);
                    
                    if (description && quantity && unit_price) {
                        items.push({
                            description,
                            quantity,
                            unit_price
                        });
                    }
                });
                
                const invoiceData = {
                    seller_info: {
                        name: formData.get('seller_name'),
                        tax_code: formData.get('seller_tax_code'),
                        address: formData.get('seller_address'),
                        phone: formData.get('seller_phone'),
                        email: formData.get('seller_email')
                    },
                    buyer_info: {
                        name: formData.get('buyer_name'),
                        tax_code: formData.get('buyer_tax_code'),
                        address: formData.get('buyer_address'),
                        phone: formData.get('buyer_phone'),
                        email: formData.get('buyer_email')
                    },
                    items: items,
                    payment_method: formData.get('payment_method'),
                    currency: formData.get('currency'),
                    notes: formData.get('notes')
                };
                
                try {
                    const response = await fetch('/invoices/create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(invoiceData)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert(`‚úì Factura generada exitosamente!\n\nN√∫mero: ${result.invoice_number}\nTotal: ${formatCurrency(result.total)}\n\nLa factura ha sido firmada digitalmente.`);
                        closeInvoiceModal();
                        loadInvoices();
                    } else {
                        alert('‚úó Error: ' + result.error);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('‚úó Error al generar la factura');
                }
            });
        }
        
        // Funciones de modal
        function openInvoiceModal() {
            document.getElementById('invoiceModal').classList.add('active');
            calculateTotals();
        }
        
        function closeInvoiceModal() {
            document.getElementById('invoiceModal').classList.remove('active');
            document.getElementById('invoiceForm').reset();
            
            // Resetear items a solo uno
            const container = document.getElementById('itemsContainer');
            container.innerHTML = `
                <div class="item-row">
                    <div class="form-group">
                        <label>Descripci√≥n:</label>
                        <input type="text" class="item-description" required>
                    </div>
                    <div class="form-group">
                        <label>Cantidad:</label>
                        <input type="number" class="item-quantity" step="0.01" value="1" required onchange="calculateTotals()">
                    </div>
                    <div class="form-group">
                        <label>Precio Unit.:</label>
                        <input type="number" class="item-price" step="0.01" required onchange="calculateTotals()">
                    </div>
                    <div class="form-group">
                        <label>Monto:</label>
                        <input type="number" class="item-amount" readonly>
                    </div>
                </div>
            `;
            calculateTotals();
        }
        
        // Ver factura
        function viewInvoice(invoiceId) {
            window.location.href = `/invoices/${invoiceId}`;
        }
        
        // Descargar PDF
        function downloadPDF(invoiceId) {
            window.location.href = `/invoices/${invoiceId}/pdf`;
        }
        
        // Descargar XML
        function downloadXML(invoiceId) {
            window.location.href = `/invoices/${invoiceId}/xml`;
        }
        
        // Utilidades
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-VN').format(amount);
        }
        
        // Recalcular al cambiar moneda
        document.addEventListener('change', function(e) {
            if (e.target.name === 'currency') {
                calculateTotals();
            }
        });
    </script>
</body>
</html>
